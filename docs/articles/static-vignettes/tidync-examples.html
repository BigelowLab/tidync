<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tidy NetCDF examples • tidync</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../jquery.sticky-kit.min.js"></script><script src="../../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../index.html">tidync</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li>
  <a href="../../articles/index.html">Articles</a>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/hypertidy/tidync">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Tidy NetCDF examples</h1>
                        <h4 class="author">Michael D. Sumner</h4>
            
            <h4 class="date">2017-06-15</h4>
          </div>

    
    
<div class="contents">
<p>Find an arbitrary NetCDF file.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="st">"/rdsi/PRIVATE/raad"</span>, <span class="st">"data/ftp.ifremer.fr/ifremer/cersat/products/gridded/psi-concentration/data/antarctic/daily/netcdf/2013/20130415.nc"</span>)</code></pre></div>
<p>NetCDF is a very widely use file format for storing array-based data as <em>variables</em>. The <strong>variable’s</strong> space is defined by its <strong>dimensions</strong> and their metadata. Dimensions are by definition “one-dimensional” consisting of one or more elements, a rectilinear virtual array with coordinate metadata on its units, type and interpretation. The <strong>space</strong> of a variable is defined as one or more of the dimensions in the file, but a variable won’t necessarily use all the available dimensions and no dimensions are mandatory or particularly special.</p>
<p>Some conventions exist to define usage and minimal standards for metadata for particular file schemas, but these are many, varied, and no particularly well adhered to in many contexts.</p>
<p>A NetCDF file is essentially a container for simple array based data structures. There is limited capacity in the formal API for accessing data randomly within a variable, the primary mechanism is to define offset and stride (start and count) hyperslab indexes. (I.e. it’s not possible to query a file for an arbitrary sparse set of values, without constructing a degenerate hyperslab query for each point or reading a hyperslab containing cells not in the set.)</p>
<div id="tidync" class="section level2">
<h2 class="hasAnchor">
<a href="#tidync" class="anchor"></a>tidync</h2>
<p>Tidync provides facilities to explore the contents of a NetCDF file and construct efficient queries to extract arbitrary hyperslabs. These can be used directly in array contexts, or in “long form” database contexts.</p>
<p>On first contact with the file, the available variables are reported (the first is made “active”) and the dimensions of the active variable are described. The “active” variable may be specified with the <code>activate</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidync)
<span class="kw"><a href="../../reference/tidync.html">tidync</a></span>(f)</code></pre></div>
<pre><code>## Variables: concentration, (quality_flag) 
## Dimensions: 
## # A tibble: 3 x 5
##   variable_name .variable_ .dimension_ dimension_name dimension_length
##           &lt;chr&gt;      &lt;dbl&gt;       &lt;int&gt;          &lt;chr&gt;            &lt;int&gt;
## 1 concentration          1           0             ni              632
## 2 concentration          1           1             nj              664
## 3 concentration          1           2           time                1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## activate another variable
<span class="kw"><a href="../../reference/tidync.html">tidync</a></span>(f) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/activate.html">activate</a></span>(concentration)</code></pre></div>
<pre><code>## Variables: concentration, (quality_flag) 
## Dimensions: 
## # A tibble: 3 x 5
##   variable_name .variable_ .dimension_ dimension_name dimension_length
##           &lt;chr&gt;      &lt;dbl&gt;       &lt;int&gt;          &lt;chr&gt;            &lt;int&gt;
## 1 concentration          1           0             ni              632
## 2 concentration          1           1             nj              664
## 3 concentration          1           2           time                1</code></pre>
<p>The term “hyperslab” is sometimes used to mean an arbitrarily-dimensioned array, and tidync uses this pattern for its main functions.</p>
<p>The ‘hyper_filter’ function allows specification of expressions to subset a variable based on each dimension’s coordinate values.</p>
<p>If no expressions are included we are presented with a table containing a row for each dimension, its extent in coordinates and its length. For convenience we also assign the activate form to an R variable, though we could just chain the entire operation without this.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">concentration &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/tidync.html">tidync</a></span>(f) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/activate.html">activate</a></span>(concentration) 

concentration <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/hyper_filter.html">hyper_filter</a></span>() </code></pre></div>
<pre><code>## [1] "filtered dimension summary: "
## # A tibble: 3 x 4
##    name    min    max length
##   &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;int&gt;
## 1    ni      1    632    632
## 2    nj      1    664    664
## 3  time 993060 993060      1</code></pre>
<p>By specifying inequality expressions we see an <em>implicit</em> subsetting of the array. Everything so far is implicit to delay any file-based computation required to actually interact with the file and read from it.</p>
<p>Notice that these are “name = expr” paired expressions, because the right hand side may be quite general we need the left hand side name to be assured of the name of the dimension referred to.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">concentration <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/hyper_filter.html">hyper_filter</a></span>(<span class="dt">nj =</span> nj <span class="op">&lt;</span><span class="st"> </span><span class="dv">20</span>)</code></pre></div>
<pre><code>## [1] "filtered dimension summary: "
## # A tibble: 3 x 4
##    name    min    max length
##   &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;int&gt;
## 1    ni      1    632    632
## 2    nj      1     19     19
## 3  time 993060 993060      1</code></pre>
<p>We can also use the special internal variable ‘step’, which will test against position in the dimension elements ‘1:length’ rather than the values. It’s not different in this case because ni and nj are just position dimensions anyway. The special ‘dplyr’ adverbs like ‘between’ will work.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">concentration <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/hyper_filter.html">hyper_filter</a></span>(<span class="dt">ni =</span> step <span class="op">&lt;</span><span class="st"> </span><span class="dv">20</span>, <span class="dt">nj =</span> dplyr<span class="op">::</span><span class="kw">between</span>(step, <span class="dv">30</span>, <span class="dv">100</span>))</code></pre></div>
<pre><code>## [1] "filtered dimension summary: "
## # A tibble: 3 x 4
##    name    min    max length
##   &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;int&gt;
## 1    ni      1     19     19
## 2    nj     30    100     71
## 3  time 993060 993060      1</code></pre>
</div>
<div id="data-extraction" class="section level2">
<h2 class="hasAnchor">
<a href="#data-extraction" class="anchor"></a>Data extraction</h2>
<p>How to use these idioms to extract actual data?</p>
<p>We can now exercise these variable choice and dimension filters to return actual data, either in by slicing out a “slab” in array-form, or as a data frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hf &lt;-<span class="st"> </span>concentration <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/hyper_filter.html">hyper_filter</a></span>(<span class="dt">ni =</span> step <span class="op">&lt;</span><span class="st"> </span><span class="dv">20</span>, <span class="dt">nj =</span> dplyr<span class="op">::</span><span class="kw">between</span>(step, <span class="dv">30</span>, <span class="dv">100</span>))

## as an array
arr &lt;-<span class="st"> </span>hf <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/hyper_slice.html">hyper_slice</a></span>()
<span class="kw">str</span>(arr)</code></pre></div>
<pre><code>##  int [1:19, 1:71] NA NA NA NA NA NA NA NA NA NA ...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## as a data frame

<span class="co">#concentration %&gt;% hyper_tibble() %&gt;% filter(!is.na(concentration))</span></code></pre></div>
</div>
<div id="real-world-example---roms-ocean-model-data" class="section level2">
<h2 class="hasAnchor">
<a href="#real-world-example---roms-ocean-model-data" class="anchor"></a>real world example - ROMS ocean model data</h2>
<p>A ROMS file typically has many variables of large size. The geographic space is curvilinear, and so we can’t use the usual affine tricks available to us with “rasters”. But, ggplot2 has no problem taking our cell values with their multidimensional coordinate values, and plotting a raster from them in the grid space.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">romsfile &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="st">"/rdsi/PRIVATE/raad"</span>,<span class="st">"data_local/acecrc.org.au/ROMS/s_corney/cpolar/ocean_his_3307.nc"</span>)
<span class="kw">format</span>(<span class="kw">file.info</span>(romsfile)<span class="op">$</span>size, <span class="dt">sci =</span> <span class="ot">TRUE</span>)</code></pre></div>
<pre><code>## [1] "2.069521e+10"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## this is a big file
<span class="kw"><a href="../../reference/tidync.html">tidync</a></span>(romsfile)</code></pre></div>
<pre><code>## Variables: AKs, (AKt, AKv, Akt_bak, Akv_bak, Cs_r, Cs_w, FSobc_in, FSobc_out, Falpha, Fbeta, Fgamma, Hsbl, M2nudg, M2obc_in, M2obc_out, M3nudg, M3obc_in, M3obc_out, Tcline, Tnudg, Tobc_in, Tobc_out, Vstretching, Vtransform, Znudg, Zob, Zos, angle, bustr, bvstr, dstart, dt, dtfast, el, f, gamma2, h, hc, lat_psi, lat_rho, lat_u, lat_v, lon_psi, lon_rho, lon_u, lon_v, mask_psi, mask_rho, mask_u, mask_v, nHIS, nRST, ndefHIS, ndtfast, nl_tnu2, nl_visc2, ntimes, pm, pn, rdrg, rdrg2, rho, rho0, salt, shflux, spherical, ssflux, sustr, svstr, swrad, temp, theta_b, theta_s, u, ubar, v, vbar, w, xl, zeta, zice) 
## Dimensions: 
## # A tibble: 4 x 5
##   variable_name .variable_ .dimension_ dimension_name dimension_length
##           &lt;chr&gt;      &lt;dbl&gt;       &lt;int&gt;          &lt;chr&gt;            &lt;int&gt;
## 1           AKs          0           3         xi_rho             1443
## 2           AKs          0           2        eta_rho              392
## 3           AKs          0           1            s_w               32
## 4           AKs          0           0     ocean_time               31</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../../reference/tidync.html">tidync</a></span>(romsfile) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/activate.html">activate</a></span>(temp)</code></pre></div>
<pre><code>## Variables: temp, (AKs, AKt, AKv, Akt_bak, Akv_bak, Cs_r, Cs_w, FSobc_in, FSobc_out, Falpha, Fbeta, Fgamma, Hsbl, M2nudg, M2obc_in, M2obc_out, M3nudg, M3obc_in, M3obc_out, Tcline, Tnudg, Tobc_in, Tobc_out, Vstretching, Vtransform, Znudg, Zob, Zos, angle, bustr, bvstr, dstart, dt, dtfast, el, f, gamma2, h, hc, lat_psi, lat_rho, lat_u, lat_v, lon_psi, lon_rho, lon_u, lon_v, mask_psi, mask_rho, mask_u, mask_v, nHIS, nRST, ndefHIS, ndtfast, nl_tnu2, nl_visc2, ntimes, pm, pn, rdrg, rdrg2, rho, rho0, salt, shflux, spherical, ssflux, sustr, svstr, swrad, theta_b, theta_s, u, ubar, v, vbar, w, xl, zeta, zice) 
## Dimensions: 
## # A tibble: 4 x 5
##   variable_name .variable_ .dimension_ dimension_name dimension_length
##           &lt;chr&gt;      &lt;dbl&gt;       &lt;int&gt;          &lt;chr&gt;            &lt;int&gt;
## 1          temp         74           3         xi_rho             1443
## 2          temp         74           2        eta_rho              392
## 3          temp         74           5          s_rho               31
## 4          temp         74           0     ocean_time               31</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../../reference/tidync.html">tidync</a></span>(romsfile) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/hyper_filter.html">hyper_filter</a></span>()</code></pre></div>
<pre><code>## [1] "filtered dimension summary: "
## # A tibble: 4 x 4
##         name        min        max length
##        &lt;chr&gt;      &lt;dbl&gt;      &lt;dbl&gt;  &lt;int&gt;
## 1     xi_rho          1       1443   1443
## 2    eta_rho          1        392    392
## 3        s_w         -1          0     32
## 4 ocean_time 1009756800 1012348800     31</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(tab &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/tidync.html">tidync</a></span>(romsfile) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/activate.html">activate</a></span>(temp) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/hyper_tibble.html">hyper_tibble</a></span>(<span class="dt">xi_rho =</span> step <span class="op">&gt;</span><span class="st"> </span><span class="dv">1000</span>, <span class="dt">s_rho =</span> s_rho <span class="op">&gt;</span><span class="st"> </span><span class="op">-</span><span class="fl">0.5</span>, <span class="dt">ocean_time =</span> step <span class="op">==</span><span class="st"> </span><span class="dv">1</span>))</code></pre></div>
<pre><code>## # A tibble: 2,604,840 x 5
##     temp xi_rho eta_rho      s_rho ocean_time
##    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;
##  1    NA   1001       1 -0.4677419 1009756800
##  2    NA   1002       1 -0.4677419 1009756800
##  3    NA   1003       1 -0.4677419 1009756800
##  4    NA   1004       1 -0.4677419 1009756800
##  5    NA   1005       1 -0.4677419 1009756800
##  6    NA   1006       1 -0.4677419 1009756800
##  7    NA   1007       1 -0.4677419 1009756800
##  8    NA   1008       1 -0.4677419 1009756800
##  9    NA   1009       1 -0.4677419 1009756800
## 10    NA   1010       1 -0.4677419 1009756800
## # ... with 2,604,830 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
<span class="kw">ggplot</span>(tab, <span class="kw">aes</span>(xi_rho, eta_rho, <span class="dt">fill =</span> temp)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_raster</span>() <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>s_rho)</code></pre></div>
<p><img src="tidync-examples_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
<p>Now for a different orientation, this time with only one longitude slice. This example really needs to map on the actual geographic depth here, so it will need to be points or a mesh, or perform resampling on a grid.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">(tab &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/tidync.html">tidync</a></span>(romsfile) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../../reference/activate.html">activate</a></span>(temp) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../../reference/hyper_tibble.html">hyper_tibble</a></span>(<span class="dt">xi_rho =</span> step <span class="op">==</span><span class="st"> </span><span class="dv">1200</span>,  <span class="dt">ocean_time =</span> step <span class="op">&lt;</span><span class="st"> </span><span class="dv">12</span>))</code></pre></div>
<pre><code>## # A tibble: 133,672 x 5
##     temp xi_rho eta_rho     s_rho ocean_time
##    &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
##  1    NA   1200       1 -0.983871 1009756800
##  2    NA   1200       2 -0.983871 1009756800
##  3    NA   1200       3 -0.983871 1009756800
##  4    NA   1200       4 -0.983871 1009756800
##  5    NA   1200       5 -0.983871 1009756800
##  6    NA   1200       6 -0.983871 1009756800
##  7    NA   1200       7 -0.983871 1009756800
##  8    NA   1200       8 -0.983871 1009756800
##  9    NA   1200       9 -0.983871 1009756800
## 10    NA   1200      10 -0.983871 1009756800
## # ... with 133,662 more rows</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ggplot2)
## model grid Y and model grid Z
<span class="kw">ggplot</span>(tab, <span class="kw">aes</span>(eta_rho, s_rho, <span class="dt">fill =</span> temp)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_raster</span>() <span class="op">+</span><span class="st"> </span><span class="kw">facet_wrap</span>(<span class="op">~</span>ocean_time)</code></pre></div>
<p><img src="tidync-examples_files/figure-html/unnamed-chunk-8-1.png" width="672"> TBD: need some more real example data set. we can use these extractions for very efficient and flexible ways to build other objects. The tibble is fairly obviously directly ready for use in <code>ggplot2</code>, and with a little more work we could generate <code>raster</code> bricks. A major motivation for this work is to be able to extract data <em>flexibly</em>, and so not be bound by the geographic assumptions of the raster package - tidync can define and pull out any arbitrary slab from any NetCDF variable, no matter it’s dimensions or purpose. Initial experiments show that for many-slice extractions (10s or 100s) the tidync approach will also be faster than the current raster implementation.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#tidync">tidync</a></li>
      <li><a href="#data-extraction">Data extraction</a></li>
      <li><a href="#real-world-example---roms-ocean-model-data">real world example - ROMS ocean model data</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Michael Sumner.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
