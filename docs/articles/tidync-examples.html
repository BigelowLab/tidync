<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NetCDF examples • tidync</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">tidync</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tidync-examples.html">NetCDF examples</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/hypertidy/tidync">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>NetCDF examples</h1>
                        <h4 class="author">Michael D. Sumner</h4>
            
            <h4 class="date">2018-02-09</h4>
          </div>

    
    
<div class="contents">
<p>The goal of tidync is to ease exploring the contents of a NetCDF source and constructing efficient queries to extract arbitrary hyperslabs. The data extracted can be used directly as an array, or in “long form” form as a data frame for “tidy” analysis and visualization contexts.</p>
<p>NetCDF is <strong>Network Common Data Form</strong>, a <a href="https://twitter.com/TedHabermann/status/958034585002041344">data model</a> and an <a href="https://en.wikipedia.org/wiki/Application_programming_interface">API</a>.</p>
<p>This is a very common, and <em>very general</em> way to store and work with scientific array-based data. NetCDF is defined and provided by <a href="https://www.unidata.ucar.edu/software/netcdf/">Unidata</a>.</p>
<p>Here we introduce traditional concepts of NetCDF, and show examples with built-in files and online sources to demonstrate tidync functionality.</p>
<div id="netcdf" class="section level1">
<h1 class="hasAnchor">
<a href="#netcdf" class="anchor"></a>NetCDF</h1>
<p>NetCDF is a very widely used file format for storing array-based data as <em>variables</em>. The <strong>space</strong> occupied by a <strong>variable</strong> is defined by its <strong>dimensions</strong> and their metadata. Dimensions are by definition <em>one-dimensional</em> (i.e. an atomic vector, in R) consisting of one or more elements, a rectilinear virtual array with coordinate metadata on its units, type and interpretation. The <strong>space</strong> of a variable is defined as one or more of the dimensions in the file, but a variable won’t necessarily use all the available dimensions and no dimensions are mandatory or particularly special.</p>
<p>Some conventions exist to define usage and minimal standards for metadata for particular file schemas, but these are many and varied, and not always adhered to.</p>
<p>Both the RNetCDF and ncdf4 packages provide a traditional summary format, familiar to many NetCDF users as the output of the command line program <a href="https://www.unidata.ucar.edu/software/netcdf/netcdf-4/newdocs/netcdf/NetCDF-Utilities.html#NetCDF-Utilities"><code>ncdump</code></a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">f &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"ifremer"</span>, <span class="st">"20171002.nc"</span>, <span class="dt">package =</span> <span class="st">"tidync"</span>)
<span class="kw">library</span>(RNetCDF)
<span class="kw"><a href="http://www.rdocumentation.org/packages/RNetCDF/topics/print.nc">print.nc</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/RNetCDF/topics/open.nc">open.nc</a></span>(f))
<span class="co">#&gt; dimensions:</span>
<span class="co">#&gt;         ni = 632 ;</span>
<span class="co">#&gt;         nj = 664 ;</span>
<span class="co">#&gt;         time = 1 ;</span>
<span class="co">#&gt; variables:</span>
<span class="co">#&gt;         int time(time) ;</span>
<span class="co">#&gt;                 time:long_name = "time" ;</span>
<span class="co">#&gt;                 time:units = "hours since 1900-1-1 0:0:0" ;</span>
<span class="co">#&gt;         byte concentration(ni, nj, time) ;</span>
<span class="co">#&gt;                 concentration:long_name = "sea-ice concentration" ;</span>
<span class="co">#&gt;                 concentration:units = "percent" ;</span>
<span class="co">#&gt;                 concentration:scale_factor = 1 ;</span>
<span class="co">#&gt;                 concentration:add_offset = 0 ;</span>
<span class="co">#&gt;                 concentration:missing_value = -128 ;</span>
<span class="co">#&gt;                 concentration:_FillValue = -128 ;</span>
<span class="co">#&gt;         byte quality_flag(ni, nj, time) ;</span>
<span class="co">#&gt;                 quality_flag:long_name = "quality_flag" ;</span>
<span class="co">#&gt;                 quality_flag:units = "n/a" ;</span>
<span class="co">#&gt;                 quality_flag:scale_factor = 1 ;</span>
<span class="co">#&gt;                 quality_flag:add_offset = 0 ;</span>
<span class="co">#&gt;                 quality_flag:missing_value = -128 ;</span>
<span class="co">#&gt;                 quality_flag:_FillValue = -128 ;</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; // global attributes:</span>
<span class="co">#&gt;                 :CONVENTIONS = "COARDS" ;</span>
<span class="co">#&gt;                 :long_name = "Sea-ice concentration as observed by SSM/I" ;</span>
<span class="co">#&gt;                 :short_name = "PSI-F18-Concentration" ;</span>
<span class="co">#&gt;                 :producer_agency = "IFREMER" ;</span>
<span class="co">#&gt;                 :producer_institution = "CERSAT" ;</span>
<span class="co">#&gt;                 :netcdf_version_id = "3.4" ;</span>
<span class="co">#&gt;                 :product_version = "2.0" ;</span>
<span class="co">#&gt;                 :creation_time = "2017-280T08:26:34.000" ;</span>
<span class="co">#&gt;                 :time_resolution = "daily" ;</span>
<span class="co">#&gt;                 :grid = "NSIDC" ;</span>
<span class="co">#&gt;                 :pole = "south" ;</span>
<span class="co">#&gt;                 :spatial_resolution = "12.5 km" ;</span>
<span class="co">#&gt;                 :platform_id = "F18" ;</span>
<span class="co">#&gt;                 :instrument = "SSM/I" ;</span></code></pre></div>
<p>Using <code>ncdump</code> at the command line on a suitable system would yield very similar output to the print above.</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="ex">ncdump</span> -h /path/to/extdata/ifremer/20171002.nc</code></pre></div>
<p>With the ncdf4 package it’s a slightly different approach, but gives the same result.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(ncdf4<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ncdf4/topics/nc_open">nc_open</a></span>(f))</code></pre></div>
<p>Notice how the listing above is organized by <em>dimension</em> and then by <em>variable</em>. It’s not particularly obvious that some variables are defined within the same set of dimensions as others.</p>
<p>A NetCDF file is a container for simple array based data structures. There is <a href="I.e.%20it's%20not%20possible%20to%20query%20a%20file%20for%20an%20arbitrary%20sparse%20set%20of%20values,%20without%20constructing%20a%20degenerate%20hyperslab%20query%20for%20each%20point%20or%20reading%20a%20hyperslab%20containing%20cells%20not%20in%20the%20set.%20Do%20you%20know%20different?%20Please%20let%20me%20know!">limited capacity</a> in the formal API for accessing data randomly within a variable, the primary mechanism is to define offset and stride (start and count) hyperslab indexes.</p>
<div id="tidync" class="section level2">
<h2 class="hasAnchor">
<a href="#tidync" class="anchor"></a>tidync</h2>
<p>Tidync aims to ease exploration of the contents of a NetCDF file and provides methods extract arbitrary hyperslabs. These can be used directly in array contexts, or in “long form” database contexts.</p>
<p>On first contact with the file, the available variables are classified by grid and dimension. The “active” grid is the one that queries may be made against, and may be changed with the <code>activate</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidync)
<span class="kw">tidync</span>(f)
<span class="co">#&gt; </span>
<span class="co">#&gt; Data Source (1): 20171002.nc ...</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Grids (2) &lt;dimension family&gt; : &lt;associated variables&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [1]   D0,D1,D2 : concentration, quality_flag    **ACTIVE GRID** ( 419648  values per variable)</span>
<span class="co">#&gt; [2]   D2       : time</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dimensions (3): </span>
<span class="co">#&gt;   </span>
<span class="co">#&gt;   dim      id name   length       min      max active start count     dmin </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;int&gt; &lt;chr&gt;   &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;lgl&gt;  &lt;int&gt; &lt;int&gt;    &lt;dbl&gt; </span>
<span class="co">#&gt; 1 D0        0 ni    632.0     1.000e⁰  6.320e² TRUE       1   632  1.000e⁰ </span>
<span class="co">#&gt; 2 D1        1 nj    664.0     1.000e⁰  6.640e² TRUE       1   664  1.000e⁰ </span>
<span class="co">#&gt; 3 D2        2 time    1.000   1.032e⁶  1.032e⁶ TRUE       1     1  1.032e⁶ </span>
<span class="co">#&gt; # ... with 3 more variables: dmax &lt;dbl&gt;, unlim &lt;lgl&gt;, coord_dim &lt;lgl&gt;</span></code></pre></div>
<p>Here we see variables are clearly grouped by the <em>grid</em> they exist in, where grid is a specific (and ordered!) set of dimensions. This allows us to see the set of variables that implicitly co-exist, they have the same <em>shape</em>. The first grid “D0,D1,D2” has two variables, <em>concentration</em> and <em>quality_flag</em>, and the second “D2” has only one variable <em>time</em>. There are no general rules here, a file might have any number of dimensions and variables, and any variable might be defined by one or more dimensions.</p>
<p>In this case the D2 grid has only one variable in its single dimension, and it happens to be a special kind of variable - a “coordinate dimension”, as indicated by the <code>coord_dim</code> flag. In the traditional <code>ncdump</code> summary above it’s easy to see there’s only really one data grid, in <code>ni,nj,time</code> that it holds two variables, and that time is a special coordinate dimension - in contrast neither <code>ni</code> or <code>nj</code> have an explicit 1-dimension variable. When there are many dimensions and/or many variables those patterns are <em>not</em> easy to see.</p>
<p>We can expand out this entire set as a single data frame, which all the coordinates copied out - this is not efficient(!) but if we craft our queries sensibly to read only what we need, it’s a very easy way to explore the data in a file.</p>
<p>The ‘hyper_filter’ function allows specification of expressions to subset a variable based on each dimension’s coordinate values.</p>
<p>If no expressions are included we are presented with a table containing a row for each dimension, its extent in coordinates and its length. For convenience we also assign the activate form to an R variable, though we could just chain the entire operation without this.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">concentration &lt;-<span class="st"> </span><span class="kw">tidync</span>(f) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">activate</span>(concentration) 
<span class="co">#&gt; Joining, by = "variable"</span>

concentration <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">hyper_filter</span>() 
<span class="co">#&gt; </span>
<span class="co">#&gt; Data Source (1): 20171002.nc ...</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Grids (2) &lt;dimension family&gt; : &lt;associated variables&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [1]   D0,D1,D2 : concentration, quality_flag    **ACTIVE GRID** ( 419648  values per variable)</span>
<span class="co">#&gt; [2]   D2       : time</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dimensions (3): </span>
<span class="co">#&gt;   </span>
<span class="co">#&gt;   dim      id name   length       min      max active start count     dmin </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;int&gt; &lt;chr&gt;   &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;lgl&gt;  &lt;int&gt; &lt;int&gt;    &lt;dbl&gt; </span>
<span class="co">#&gt; 1 D0        0 ni    632.0     1.000e⁰  6.320e² TRUE       1   632  1.000e⁰ </span>
<span class="co">#&gt; 2 D1        1 nj    664.0     1.000e⁰  6.640e² TRUE       1   664  1.000e⁰ </span>
<span class="co">#&gt; 3 D2        2 time    1.000   1.032e⁶  1.032e⁶ TRUE       1     1  1.032e⁶ </span>
<span class="co">#&gt; # ... with 3 more variables: dmax &lt;dbl&gt;, unlim &lt;lgl&gt;, coord_dim &lt;lgl&gt;</span></code></pre></div>
<p>By specifying inequality expressions we see an <em>implicit</em> subsetting of the array. Everything so far is implicit to delay any file-based computation required to actually interact with the file and read from it.</p>
<p>Notice that these are “name = expr” paired expressions, because the right hand side may be quite general we need the left hand side name to be assured of the name of the dimension referred to.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
concentration <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">hyper_filter</span>(<span class="dt">nj =</span> nj <span class="op">&lt;</span><span class="st"> </span><span class="dv">20</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; Data Source (1): 20171002.nc ...</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Grids (2) &lt;dimension family&gt; : &lt;associated variables&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [1]   D0,D1,D2 : concentration, quality_flag    **ACTIVE GRID** ( 419648  values per variable)</span>
<span class="co">#&gt; [2]   D2       : time</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dimensions (3): </span>
<span class="co">#&gt;   </span>
<span class="co">#&gt;   dim      id name   length       min      max active start count     dmin </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;int&gt; &lt;chr&gt;   &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;lgl&gt;  &lt;int&gt; &lt;int&gt;    &lt;dbl&gt; </span>
<span class="co">#&gt; 1 D0        0 ni    632.0     1.000e⁰  6.320e² TRUE       1   632  1.000e⁰ </span>
<span class="co">#&gt; 2 D1        1 nj    664.0     1.000e⁰  6.640e² TRUE       1    19  1.000e⁰ </span>
<span class="co">#&gt; 3 D2        2 time    1.000   1.032e⁶  1.032e⁶ TRUE       1     1  1.032e⁶ </span>
<span class="co">#&gt; # ... with 3 more variables: dmax &lt;dbl&gt;, unlim &lt;lgl&gt;, coord_dim &lt;lgl&gt;</span></code></pre></div>
<p>We can also use the special internal variable ‘step’, which will test against position in the dimension elements ‘1:length’ rather than the values. It’s not different in this case because ni and nj are just position dimensions anyway. The special ‘dplyr’ adverbs like ‘between’ will work.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">concentration <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">hyper_filter</span>(<span class="dt">ni =</span> index <span class="op">&lt;</span><span class="st"> </span><span class="dv">20</span>, <span class="dt">nj =</span> dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/between.html">between</a></span>(index, <span class="dv">30</span>, <span class="dv">100</span>))
<span class="co">#&gt; </span>
<span class="co">#&gt; Data Source (1): 20171002.nc ...</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Grids (2) &lt;dimension family&gt; : &lt;associated variables&gt; </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; [1]   D0,D1,D2 : concentration, quality_flag    **ACTIVE GRID** ( 419648  values per variable)</span>
<span class="co">#&gt; [2]   D2       : time</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Dimensions (3): </span>
<span class="co">#&gt;   </span>
<span class="co">#&gt;   dim      id name   length       min      max active start count     dmin </span>
<span class="co">#&gt;   &lt;chr&gt; &lt;int&gt; &lt;chr&gt;   &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt; &lt;lgl&gt;  &lt;int&gt; &lt;int&gt;    &lt;dbl&gt; </span>
<span class="co">#&gt; 1 D0        0 ni    632.0     1.000e⁰  6.320e² TRUE       1    19  1.000e⁰ </span>
<span class="co">#&gt; 2 D1        1 nj    664.0     1.000e⁰  6.640e² TRUE      30    71  3.000e¹ </span>
<span class="co">#&gt; 3 D2        2 time    1.000   1.032e⁶  1.032e⁶ TRUE       1     1  1.032e⁶ </span>
<span class="co">#&gt; # ... with 3 more variables: dmax &lt;dbl&gt;, unlim &lt;lgl&gt;, coord_dim &lt;lgl&gt;</span></code></pre></div>
</div>
<div id="data-extraction" class="section level2">
<h2 class="hasAnchor">
<a href="#data-extraction" class="anchor"></a>Data extraction</h2>
<p>How to use these idioms to extract actual data?</p>
<p>We can now exercise these variable choice and dimension filters to return actual data, either in by slicing out a “slab” in array-form, or as a data frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hf &lt;-<span class="st"> </span>concentration <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">hyper_filter</span>(<span class="dt">ni =</span> index <span class="op">&lt;</span><span class="st"> </span><span class="dv">20</span>, <span class="dt">nj =</span> dplyr<span class="op">::</span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/between.html">between</a></span>(index, <span class="dv">30</span>, <span class="dv">100</span>))

## as an array
arr &lt;-<span class="st"> </span>hf <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">hyper_slice</span>()
<span class="kw">str</span>(arr)
<span class="co">#&gt; List of 1</span>
<span class="co">#&gt;  $ concentration: int [1:19, 1:71] NA NA NA NA NA NA NA NA NA NA ...</span>

## as a data frame

<span class="co">#concentration %&gt;% hyper_tibble() %&gt;% filter(!is.na(concentration))</span></code></pre></div>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#netcdf">NetCDF</a><ul class="nav nav-pills nav-stacked">
<li><a href="#tidync">tidync</a></li>
      <li><a href="#data-extraction">Data extraction</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Michael Sumner.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
